use crate::ast;

type I = ast::ITypeOp;
type J = ast::JTypeOp;
type R = ast::RTypeOp;

#[rustfmt::skip]
pub fn assemble(insts: Vec<ast::Instruction>) -> Vec<u32> {
    let mut bytes = vec![];
    for inst in insts {
        let i = match inst {
            ast::Instruction::Immediate { op, rs, rt, imm } => match op {
                I::Addi => 0b001000 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Addiu => 0b001001 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Andi => 0b001100 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Bc0f => 0b010000 << 26 | 0b01000 << 21 | imm.as_u32(),
                I::Bc0fl => 0b010000 << 26 | 0b01000 << 21 | 0b00010 << 16 | imm.as_u32(),
                I::Bc0t => 0b010000 << 26 | 0b01000 << 21 | 0b00001 << 16 | imm.as_u32(),
                I::Bc0tl => 0b010000 << 26 | 0b01000 << 21 | 0b00011 << 16 | imm.as_u32(),
                I::Bc1f => 0b010001 << 26 | 0b01000 << 21 | imm.as_u32(),
                I::Bc1fl => 0b010001 << 26 | 0b01000 << 21 | 0b00010 << 16 | imm.as_u32(),
                I::Bc1t => 0b010001 << 26 | 0b01000 << 21 | 0b00001 << 16 | imm.as_u32(),
                I::Bc1tl => 0b010001 << 26 | 0b01000 << 21 | 0b00011 << 16 | imm.as_u32(),
                I::Beq => 0b000100 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Beql => 0b010100 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Beqz => 0b000100 << 26 | rs.as_num() << 21 | imm.as_u32(),
                I::Bgez => 0b000001 << 26 | rs.as_num() << 21 | 0b00001 << 16 | imm.as_u32(),
                I::Bgezal => 0b000001 << 26 | rs.as_num() << 21 | 0b10001 << 16 | imm.as_u32(),
                I::Bgezall => 0b000001 << 26 | rs.as_num() << 21 | 0b10011 << 16 | imm.as_u32(),
                I::Bgezl => 0b000001 << 26 | rs.as_num() << 21 | 0b00011 << 16 | imm.as_u32(),
                I::Bgtz => 0b000111 << 26 | rs.as_num() << 21 | imm.as_u32(),
                I::Bgtzl => 0b010111 << 26 | rs.as_num() << 21 | imm.as_u32(),
                I::Blez => 0b000110 << 26 | rs.as_num() << 21| imm.as_u32(),
                I::Blezl => 0b010110 << 26 | rs.as_num() << 21| imm.as_u32(),
                I::Bltz => 0b000001 << 26 | rs.as_num() << 21 | imm.as_u32(),
                I::Bltzal => 0b000001 << 26 | rs.as_num() << 21 | 0b10000 << 16 | imm.as_u32(),
                I::Bltzall => 0b000001 << 26 | rs.as_num() << 21 | 0b10010 << 16 | imm.as_u32(),
                I::Bltzl => 0b000001 << 26 | rs.as_num() << 21 | 0b00010 << 16 | imm.as_u32(),
                I::Bne => 0b000101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Bnel => 0b010101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Bnez => 0b000101 << 26 | rs.as_num() << 21| imm.as_u32(),
                I::Cache => 0b101111 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Daddi => 0b011000 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Daddiu => 0b011001 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lb => 0b100000 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lbu => 0b100100 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Ld => 0b110111 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Ldc1 => 0b110101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Ldc2 => 0b110101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Ldl => 0b011010 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Ldr => 0b011011 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lh => 0b100001 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lhu => 0b100101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Ll => 0b110000 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lld => 0b110100 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lui => 0b001111 << 26 | rt.as_num() << 16 | imm.as_u32(),
                I::Lw => 0b100011 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lwc1 => 0b110001 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lwc2 => 0b110001 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lwl => 0b100010 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lwr => 0b100110 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Lwu => 0b100111 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Ori => 0b001101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sb => 0b101000 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sc => 0b111000 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Scd => 0b111100 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sd => 0b111111 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sdc1 => 0b111101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sdc2 => 0b111101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sdl => 0b101100 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sdr => 0b101101 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sh => 0b101001 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Slti => 0b001010 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sltiu => 0b001011 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Sw => 0b101011 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Swc1 => 0b111001 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Swc2 => 0b111001 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Swl => 0b101010 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Swr => 0b101110 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
                I::Teqi => 0b000001 << 26 | rs.as_num() << 21 | 0b01100 << 16 | imm.as_u32(),
                I::Tgei => 0b000001 << 26 | rs.as_num() << 21 | 0b01000 << 16 | imm.as_u32(),
                I::Tgeiu => 0b000001 << 26 | rs.as_num() << 21 | 0b01001 << 16 | imm.as_u32(),
                I::Tlti => 0b000001 << 26 | rs.as_num() << 21 | 0b01010 << 16 | imm.as_u32(),
                I::Tltiu => 0b000001 << 26 | rs.as_num() << 21 | 0b01011 << 16 | imm.as_u32(),
                I::Tnei => 0b000001 << 26 | rs.as_num() << 21 | 0b01110 << 16 | imm.as_u32(),
                I::Xori => 0b001110 << 26 | rs.as_num() << 21 | rt.as_num() << 16 | imm.as_u32(),
            }
            ast::Instruction::Jump { op, target } => match op {
                J::J => 0b000010 << 26 | (target.as_u32() & 0x3FFFFFF) >> 2,
                J::Jal => 0b000011 << 26 | (target.as_u32() & 0x3FFFFFF) >> 2,
            }
            ast::Instruction::Register { op, rs, rt, rd, sa } => match op {
                R::AbsS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000101,
                R::AbsD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000101,
                R::Add => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b100000,
                R::Addu => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b100001,
                R::AddS => 0b010001 << 26 | 0b10000 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | rd.as_num() << 6,
                R::AddD => 0b010001 << 26 | 0b10001 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | rd.as_num() << 6,
                R::And => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b100100,
                R::Break => 0b001101,
                R::Cs => 0b010001 << 26 | 0b10000 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | 0b0000011 << 4 | sa as u32,
                R::Cd => 0b010001 << 26 | 0b10001 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | 0b0000011 << 4 | sa as u32,
                R::CeilLS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001010,
                R::CeilLD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001010,
                R::CeilWS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001110,
                R::CeilWD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001110,
                R::Cfc1 => 0b010001 << 26 | 0b00010 << 21 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Ctc1 => 0b010001 << 26 | 0b00110 << 21 | rt.as_num() << 16 | rd.as_num() << 11,
                R::CvtDS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100001,
                R::CvtDW => 0b010001 << 26 | 0b10100 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100001,
                R::CvtDL => 0b010001 << 26 | 0b10101 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100001,
                R::CvtLS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100101,
                R::CvtLD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100101,
                R::CvtSD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100000,
                R::CvtSW => 0b010001 << 26 | 0b10100 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100000,
                R::CvtSL => 0b010001 << 26 | 0b10101 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100000,
                R::CvtWS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100100,
                R::CvtWD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b100100,
                R::Dadd => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b101100,
                R::Daddu => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b101101,
                R::Ddiv => rs.as_num() << 21 | rt.as_num() << 16 | 0b011110,
                R::Ddivu => rs.as_num() << 21 | rt.as_num() << 16 | 0b011111,
                R::Div => rs.as_num() << 21 | rt.as_num() << 16 | 0b011010,
                R::Divu => rs.as_num() << 21 | rt.as_num() << 16 | 0b011011,
                R::DivS => 0b010001 << 26 | 0b10000 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000011,
                R::DivD => 0b010001 << 26 | 0b10001 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000011,
                R::Dmfc0 => 0b010000 << 26 | 0b00001 << 21 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Dmfc1 => 0b010001 << 26 | 0b00001 << 21 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Dmtc0 => 0b010000 << 26 | 0b00101 << 21 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Dmtc1 => 0b010001 << 26 | 0b00101 << 21 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Dmult => rs.as_num() << 21 | rt.as_num() << 16 | 0b011100,
                R::Dmultu => rs.as_num() << 21 | rt.as_num() << 16 | 0b011101,
                R::Dsll => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6 | 0b111000,
                R::Dsll32 => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6 | 0b111100,
                R::Dsllv => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b010100,
                R::Dsra => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6 | 0b111011,
                R::Dsra32 => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6 | 0b111111,
                R::Dsrav => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b010111,
                R::Dsrl => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6 | 0b111010,
                R::Dsrl32 => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6 | 0b111110,
                R::Dsrlv => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b010110,
                R::Dsub => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b101110,
                R::Dsubu => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b101111,
                R::Eret => 0b010000 << 26 | 0b00001 << 25 | 0b011000,
                R::FloorLS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001011,
                R::FloorLD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001011,
                R::FloorWS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001111,
                R::FloorWD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001111,
                R::Jalr => rs.as_num() << 21 | rd.as_num() << 11 | 0b001001,
                R::Jr => rs.as_num() << 21 | 0b001000,
                R::Mfc0 => 0b010000 << 26 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Mfc1 => 0b010001 << 26 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Mfhi => rd.as_num() << 11 | 0b010000,
                R::Mflo => rd.as_num() << 11 | 0b010010,
                R::MovS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000110,
                R::MovD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000110,
                R::Mtc0 => 0b010000 << 26 | 0b00100 << 21 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Mtc1 => 0b010001 << 26 | 0b00100 << 21 | rt.as_num() << 16 | rd.as_num() << 11,
                R::Mthi => rs.as_num() << 21 | 0b010001,
                R::Mtlo => rs.as_num() << 21 | 0b010011,
                R::MulS => 0b010001 << 26 | 0b10000 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000010,
                R::MulD => 0b010001 << 26 | 0b10001 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000010,
                R::Mult => rs.as_num() << 21 | rt.as_num() << 16 | 0b011000,
                R::Multu => rs.as_num() << 21 | rt.as_num() << 16 | 0b011001,
                R::NegS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000111,
                R::NegD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000111,
                R::Negu => rs.as_num() << 16 | rd.as_num() << 11 | 0b100011,
                R::Nor => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b100111,
                R::Or => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b100101,
                R::RoundLS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001000,
                R::RoundLD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001000,
                R::RoundWS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001100,
                R::RoundWD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001100,
                R::Sll => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6,
                R::Sllv => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b000100,
                R::Slt => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b101010,
                R::Sltu => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b101011,
                R::SqrtS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000100,
                R::SqrtD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000100,
                R::Sra => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6 | 0b000011,
                R::Srav => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b000111,
                R::Srl => rt.as_num() << 16 | rd.as_num() << 11 | (sa as u32) << 6 | 0b000010,
                R::Srlv => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b000110,
                R::Sub => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b100010,
                R::Subu => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b100011,
                R::SubS => 0b010001 << 26 | 0b10000 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000001,
                R::SubD => 0b010001 << 26 | 0b10001 << 21 | rt.as_num() << 16 | rs.as_num() << 11 | rd.as_num() << 6 | 0b000001,
                R::Sync => 0b001111,
                R::Syscall => 0b001100,
                R::Teq => rs.as_num() << 21 | rt.as_num() << 16 | 0b110100,
                R::Tge => rs.as_num() << 21 | rt.as_num() << 16 | 0b110000,
                R::Tgeu => rs.as_num() << 21 | rt.as_num() << 16 | 0b110001,
                R::Tlbp => 0b010000 << 26 | 0b00001 << 25 | 0b001000,
                R::Tlbr => 0b010000 << 26 | 0b00001 << 25 | 0b000001,
                R::Tlbwi => 0b010000 << 26 | 0b00001 << 25 | 0b000010,
                R::Tlbwr => 0b010000 << 26 | 0b00001 << 25 | 0b000110,
                R::Tlt => rs.as_num() << 21 | rt.as_num() << 16 | 0b110010,
                R::Tltu => rs.as_num() << 21 | rt.as_num() << 16 | 0b110011,
                R::Tne => rs.as_num() << 21 | rt.as_num() << 16 | 0b110110,
                R::TruncLS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001001,
                R::TruncLD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001001,
                R::TruncWS => 0b010001 << 26 | 0b10000 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001101,
                R::TruncWD => 0b010001 << 26 | 0b10001 << 21 | rs.as_num() << 11 | rd.as_num() << 6 | 0b001101,
                R::Xor => rs.as_num() << 21 | rt.as_num() << 16 | rd.as_num() << 11 | 0b100110,
            }
        };
        bytes.push(i);
    }
    bytes
}
